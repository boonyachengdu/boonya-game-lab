<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人资料 - MetaAuth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .avatar-section {
            text-align: center;
            padding: 20px;
        }
        .avatar-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .avatar-upload {
            position: relative;
            display: inline-block;
        }
        .avatar-upload-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .stats-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stats-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        .nav-tabs-custom {
            border-bottom: 2px solid #e9ecef;
        }
        .nav-tabs-custom .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 24px;
        }
        .nav-tabs-custom .nav-link.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: transparent;
        }
        .info-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
            min-width: 120px;
        }
        .info-value {
            color: #6c757d;
        }
        .edit-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
        }
        .security-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        .activity-item {
            padding: 12px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .activity-time {
            font-size: 0.875rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
<!-- 头部导航 -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">
            <i class="bi bi-shield-check"></i> MetaAuth
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/}">首页</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/profile}">个人资料</a>
                </li>
                <li class="nav-item"  th:if="${isAdmin}" sec:authorize="hasRole('ADMIN')">
                    <a class="nav-link" th:href="@{/admin/users}">用户管理</a>
                </li>
            </ul>
            <div class="navbar-nav">
                <span class="navbar-text me-3" sec:authentication="name"></span>
                <a th:href="@{/logout}" class="btn btn-outline-light btn-sm">退出</a>
            </div>
        </div>
    </div>
</nav>

<div class="profile-container">
    <!-- 个人资料头部 -->
    <div class="profile-header">
        <div class="row align-items-center">
            <div class="col-md-3 text-center">
                <div class="avatar-upload">
                    <img th:src="${user.avatar ?: '/images/default-avatar.png'}"
                         class="avatar-img"
                         alt="用户头像"
                         onerror="this.src='/images/default-avatar.png'">
                    <button class="avatar-upload-btn" data-bs-toggle="modal" data-bs-target="#avatarModal">
                        <i class="bi bi-camera"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-9">
                <h2 th:text="${user.username}">用户名</h2>
                <p class="mb-1" th:text="${user.email}">用户邮箱</p>
                <p class="mb-0">
                        <span class="badge bg-light text-dark me-2" th:each="role : ${user.roles}"
                              th:text="${role.name}"></span>
                </p>
            </div>
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card text-center">
                <div class="stats-number" th:text="${userStats.loginCount ?: 0}">0</div>
                <div class="text-muted">登录次数</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <div class="stats-number" th:text="${userStats.daysSinceJoin ?: 0}">0</div>
                <div class="text-muted">加入天数</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <div class="stats-number" th:text="${userStats.lastActiveDays ?: 0}">0</div>
                <div class="text-muted">最近活跃</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card text-center">
                <div class="stats-number" th:text="${userStats.securityScore ?: 0}">0</div>
                <div class="text-muted">安全评分</div>
            </div>
        </div>
    </div>

    <!-- 标签页导航 -->
    <ul class="nav nav-tabs nav-tabs-custom mb-4" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab"
                    data-bs-target="#basic" type="button" role="tab">
                <i class="bi bi-person me-1"></i>基本信息
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab"
                    data-bs-target="#security" type="button" role="tab">
                <i class="bi bi-shield-lock me-1"></i>安全设置
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="activity-tab" data-bs-toggle="tab"
                    data-bs-target="#activity" type="button" role="tab">
                <i class="bi bi-clock-history me-1"></i>活动记录
            </button>
        </li>
    </ul>

    <!-- 标签页内容 -->
    <div class="tab-content" id="profileTabsContent">
        <!-- 基本信息标签页 -->
        <div class="tab-pane fade show active" id="basic" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">基本信息</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                        <i class="bi bi-pencil me-1"></i>编辑资料
                    </button>
                </div>
                <div class="card-body">
                    <div class="info-item">
                        <span class="info-label">用户名</span>
                        <span class="info-value" th:text="${user.username}"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">邮箱地址</span>
                        <span class="info-value" th:text="${user.email}"></span>
                        <span class="security-badge badge-success">
                                <i class="bi bi-check-circle me-1"></i>已验证
                            </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">手机号码</span>
                        <span class="info-value" th:if="${user.phone != null}" th:text="${user.phone}"></span>
                        <span class="info-value" th:if="${user.phone == null}" th:text="未设置"></span>
                        <span th:if="${user.phone == null or user.phone == ''}" class="security-badge badge-warning">
                                <i class="bi bi-exclamation-triangle me-1"></i>未设置
                            </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">账户状态</span>
                        <span class="info-value">
                                <span th:switch="${user.status}" class="badge">
                                    <span th:case="ACTIVE" class="bg-success">活跃</span>
                                    <span th:case="INACTIVE" class="bg-warning">禁用</span>
                                    <span th:case="LOCKED" class="bg-danger">锁定</span>
                                </span>
                            </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">注册时间</span>
                        <span class="info-value" th:text="${#temporals.format(user.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">最后登录</span>
                        <span class="info-value"
                              th:if="${user.lastLogin != null}"
                              th:text="${#temporals.format(user.lastLogin, 'yyyy-MM-dd HH:mm')}"></span>
                        <span class="info-value"
                              th:if="${user.lastLogin == null}"
                              th:text="'从未登录'"></span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">所属角色</span>
                        <span class="info-value">
                                <span th:each="role : ${user.roles}" class="badge bg-secondary me-1"
                                      th:text="${role.name}"></span>
                            </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 安全设置标签页 -->
        <div class="tab-pane fade" id="security" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">安全设置</h5>
                </div>
                <div class="card-body">
                    <div class="info-item">
                        <div>
                            <span class="info-label">登录密码</span>
                            <div class="info-value">最后一次修改：2个月前</div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                            修改密码
                        </button>
                    </div>
                    <div class="info-item">
                        <div>
                            <span class="info-label">双重认证</span>
                            <div class="info-value">未启用，建议开启以提高账户安全</div>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm">启用2FA</button>
                    </div>
                    <div class="info-item">
                        <div>
                            <span class="info-label">登录会话</span>
                            <div class="info-value">当前有1个活跃会话</div>
                        </div>
                        <button class="btn btn-outline-info btn-sm">查看会话</button>
                    </div>
                    <div class="info-item">
                        <div>
                            <span class="info-label">账户恢复</span>
                            <div class="info-value">已设置安全邮箱用于账户恢复</div>
                        </div>
                        <button class="btn btn-outline-warning btn-sm">设置恢复选项</button>
                    </div>
                </div>
            </div>

            <!-- 安全建议 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">安全建议</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-shield-exclamation me-2"></i>
                        <strong>建议操作：</strong>
                        <ul class="mb-0 mt-2">
                            <li>启用双重认证以增强账户安全</li>
                            <li>定期更新密码，建议每90天更换一次</li>
                            <li>检查最近的登录活动，确保没有异常</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 活动记录标签页 -->
        <div class="tab-pane fade" id="activity" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">最近活动</h5>
                    <button class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-download me-1"></i>导出记录
                    </button>
                </div>
                <div class="card-body">
                    <div th:each="activity : ${userActivities}" class="activity-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <i class="bi bi-box-arrow-in-right text-success me-2"
                                   th:if="${activity.type == 'LOGIN'}"></i>
                                <i class="bi bi-key text-warning me-2"
                                   th:if="${activity.type == 'PASSWORD_CHANGE'}"></i>
                                <i class="bi bi-pencil text-primary me-2"
                                   th:if="${activity.type == 'PROFILE_UPDATE'}"></i>
                                <span th:text="${activity.description}">用户登录</span>
                            </div>
                            <div class="activity-time"
                                 th:text="${#temporals.format(activity.timestamp, 'MM-dd HH:mm')}">
                                10-20 14:30
                            </div>
                        </div>
                    </div>

                    <!-- 如果没有活动记录 -->
                    <div th:if="${#lists.isEmpty(userActivities)}" class="text-center py-4">
                        <i class="bi bi-clock-history display-4 text-muted mb-3"></i>
                        <p class="text-muted">暂无活动记录</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 编辑资料模态框 -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">编辑个人资料</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/profile/update}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="email" class="form-label">邮箱地址</label>
                        <input type="email" class="form-control" id="email" name="email"
                               th:value="${user.email}" required>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">手机号码</label>
                        <input type="tel" class="form-control" id="phone" name="phone"
                               th:value="${user.phone ?: ''}"
                               placeholder="请输入手机号码">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">通知设置</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                            <label class="form-check-label" for="emailNotifications">
                                邮箱通知
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="smsNotifications">
                            <label class="form-check-label" for="smsNotifications">
                                短信通知
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存更改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 修改密码模态框 -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">修改密码</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/profile/change-password}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">当前密码</label>
                        <input type="password" class="form-control" id="currentPassword"
                               name="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">新密码</label>
                        <input type="password" class="form-control" id="newPassword"
                               name="newPassword" required>
                        <div class="form-text">密码长度至少8位，包含字母和数字</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">确认新密码</label>
                        <input type="password" class="form-control" id="confirmPassword"
                               name="confirmPassword" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">更新密码</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 头像上传模态框 -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">更换头像</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/profile/upload-avatar}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <img id="avatarPreview" th:src="${user.avatar ?: '/images/default-avatar.png'}"
                             class="avatar-img" alt="头像预览">
                    </div>
                    <div class="mb-3">
                        <label for="avatarFile" class="form-label">选择头像图片</label>
                        <input class="form-control" type="file" id="avatarFile" name="avatarFile"
                               accept="image/*" onchange="previewAvatar(this)">
                        <div class="form-text">支持 JPG、PNG 格式，大小不超过 2MB</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">上传头像</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 头像预览功能
    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 密码验证
    document.addEventListener('DOMContentLoaded', function() {
        const passwordForm = document.querySelector('form[th\\:action="@{/profile/change-password}"]');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    e.preventDefault();
                    alert('新密码和确认密码不匹配！');
                    return false;
                }

                if (newPassword.length < 8) {
                    e.preventDefault();
                    alert('密码长度至少8位！');
                    return false;
                }
            });
        }
    });

    // 标签页状态保持
    const profileTabs = document.getElementById('profileTabs');
    if (profileTabs) {
        profileTabs.addEventListener('show.bs.tab', function(event) {
            const tabId = event.target.getAttribute('data-bs-target');
            localStorage.setItem('activeProfileTab', tabId);
        });

        // 恢复上次激活的标签页
        const activeTab = localStorage.getItem('activeProfileTab');
        if (activeTab) {
            const tabElement = document.querySelector(`[data-bs-target="${activeTab}"]`);
            if (tabElement) {
                new bootstrap.Tab(tabElement).show();
            }
        }
    }
</script>
</body>
</html>